- name: Deploy to VM
  run: |
    ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_IP" << 'REMOTE'
      set -euxo pipefail

      echo "ðŸ“‚ Moving to repo"
      cd /home/azureuser/enterprise-devops-ml-platform

      echo "ðŸ”„ Updating code"
      git fetch origin
      git reset --hard origin/feature/devops-platform

      echo "ðŸ³ Checking Docker"
      docker --version

      echo "ðŸ³ Checking docker-compose"
      if ! command -v docker-compose >/dev/null 2>&1; then
        echo "Installing docker-compose..."
        sudo apt update
        sudo apt install -y docker-compose
      fi

      echo "ðŸ›‘ Stopping old containers"
      docker-compose down || true

      echo "ðŸš€ Building and starting containers"
      docker-compose up -d --build

      echo "âœ… Containers running"
      docker ps
    REMOTE

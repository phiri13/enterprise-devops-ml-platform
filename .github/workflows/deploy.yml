name: CI/CD - FastAPI Deployment

on:
  push:
    branches:
      - feature/devops-platform
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VM_IP: ${{ secrets.VM_IP }}
      SSH_USER: ${{ secrets.SSH_USER }}
      REPO_PATH: /home/azureuser/enterprise-devops-ml-platform
      BRANCH: feature/devops-platform
      MAX_HEALTH_RETRIES: 15
      HEALTH_SLEEP_SEC: 2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.VM_IP }}" ] || [ -z "${{ secrets.SSH_USER }}" ] || [ -z "${{ secrets.SSH_KEY }}" ]; then
            echo "Missing required secrets: VM_IP, SSH_USER, or SSH_KEY" >&2
            exit 1
          fi
          echo "Secrets present"

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Test SSH connectivity from runner
        run: |
          echo "Testing SSH connectivity to $SSH_USER@$VM_IP ..."
          ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=10 "$SSH_USER@$VM_IP" 'echo SSH_OK' || { echo "SSH failed"; exit 1; }

      - name: Deploy to VM with verbose logging
        run: |
          set -x
          ssh -vvv -o StrictHostKeyChecking=no "$SSH_USER@$VM_IP" <<'REMOTE'
            set -euo pipefail
            cd /home/azureuser/enterprise-devops-ml-platform || { echo "Repo path missing"; exit 2; }

            # Ensure branch is present and reset to remote
            git fetch origin --depth=1 || { echo "git fetch failed"; exit 3; }
            git reset --hard origin/feature/devops-platform || { echo "git reset failed"; exit 4; }

            # Kill any process on port 8000 safely
            if command -v lsof >/dev/null 2>&1; then
              PID=$(lsof -ti:8000 || true)
              if [ -n "$PID" ]; then
                echo "Killing process(es) on port 8000: $PID"
                kill -9 $PID || true
              fi
            else
              echo "lsof not found; skipping port kill."
            fi

            # Restart containers
            docker-compose down || true
            docker-compose up -d --build || { echo "docker-compose up failed"; exit 5; }

            # Run deployment script if present
            if [ -f deployment.sh ]; then
              chmod +x deployment.sh
              ./deployment.sh || { echo "deployment.sh failed"; exit 6; }
            else
              echo "No deployment.sh found, skipping."
            fi

            # Print container status
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
REMOTE

      - name: Confirm deployment (health check)
        run: |
          echo "Waiting for API to become healthy..."
          for i in $(seq 1 $MAX_HEALTH_RETRIES); do
            if curl -fsS http://$VM_IP:8000/health >/dev/null 2>&1; then
              echo "âœ… API is healthy (attempt $i)"
              exit 0
            fi
            echo "â³ attempt $i/$MAX_HEALTH_RETRIES - waiting $HEALTH_SLEEP_SEC seconds..."
            sleep $HEALTH_SLEEP_SEC
          done
          echo "âŒ Health check failed after $MAX_HEALTH_RETRIES retries" >&2
          exit 1

      - name: Deployment complete
        run: echo "ðŸŽ‰ Deployment to $VM_IP completed successfully."

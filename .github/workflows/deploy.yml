# ...existing code...
name: CI/CD - FastAPI Deployment

on:
  push:
    branches:
      - feature/devops-platform
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VM_IP: ${{ secrets.VM_IP }}
      SSH_USER: ${{ secrets.SSH_USER }}
      REPO_PATH: /home/azureuser/enterprise-devops-ml-platform

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.VM_IP }}" ] || [ -z "${{ secrets.SSH_USER }}" ] || [ -z "${{ secrets.SSH_KEY }}" ]; then
            echo "Missing required secrets: VM_IP, SSH_USER, or SSH_KEY" >&2
            exit 1
          fi

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Deploy to VM
        run: |
          echo "Connecting to VM and updating code..."
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_IP" <<'REMOTE'
            set -e
            cd "$REPO_PATH"
            git reset --hard
            git pull origin feature/devops-platform

            PID=$(lsof -ti:8000)
            if [ ! -z "$PID" ]; then
              echo "Killing processes on port 8000: $PID"
              kill -9 $PID
            fi

            docker-compose down || true
            docker-compose up -d --build
            ./deployment.sh
          REMOTE

      - name: Confirm deployment
        run: |
          echo "Checking health endpoint..."
          curl -sS http://$VM_IP:8000/health || (echo "Health check failed" >&2; exit 1)
          echo "âœ… Deployment complete."
# ...existing code...
